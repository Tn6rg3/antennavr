<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Optical Ham Radio Planner</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; background-color: #000; color: white; touch-action: none; }
        
        /* Fotocamera in background */
        #camera-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        
        /* UI Sopra la fotocamera */
        #ui-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: space-between; z-index: 10; padding: 10px; box-sizing: border-box; pointer-events: none; }
        
        /* Mirino Centrale */
        #crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 40px; height: 40px; z-index: 5; }
        #crosshair::before, #crosshair::after { content: ''; position: absolute; background: #2ed573; }
        #crosshair::before { top: 19px; left: 0; width: 40px; height: 2px; }
        #crosshair::after { top: 0; left: 19px; width: 2px; height: 40px; }
        #angle-display { position: absolute; top: 50%; left: 50%; transform: translate(30px, -10px); color: #2ed573; font-weight: bold; font-size: 14px; text-shadow: 1px 1px 2px black; z-index: 5;}

        /* Pannelli dati */
        #top-bar { display: flex; justify-content: space-between; width: 100%; pointer-events: auto; }
        
        .panel { background: rgba(10, 20, 30, 0.85); padding: 10px; border-radius: 8px; font-size: 13px; backdrop-filter: blur(4px); box-shadow: 0 4px 6px rgba(0,0,0,0.5);}
        #dataPanel { border-left: 3px solid #ffdd59; width: 45%; }
        #antennaPanel { border-right: 3px solid #1e90ff; width: 48%; display: none; }
        
        .data-value { font-weight: bold; color: #ffdd59; font-size: 15px; }
        .data-row { margin-bottom: 5px; }
        
        #antennaPanel select, #antennaPanel input { width: 100%; margin-top: 5px; margin-bottom: 5px; padding: 5px; background: #222; color: white; border: 1px solid #555; border-radius: 4px;}
        .ant-settings { display: none; margin-top: 10px; border-top: 1px solid #555; padding-top: 5px;}
        #warning { color: #ff4757; font-weight: bold; font-size: 12px; display: none; margin-top: 5px; animation: blink 1s infinite;}
        @keyframes blink { 50% { opacity: 0.5; } }

        /* Controlli in basso */
        .bottom-controls { display: flex; flex-direction: column; align-items: center; gap: 8px; width: 100%; pointer-events: auto; padding-bottom: 20px;}
        
        #instruction { text-align: center; color: #000; font-weight: bold; background: #ffdd59; padding: 10px; border-radius: 8px; width: 100%; box-sizing: border-box; font-size: 14px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);}
        
        .action-btn { padding: 15px; font-size: 16px; font-weight: bold; border-radius: 8px; border: none; cursor: pointer; color: white; width: 100%; background: #2ed573; box-shadow: 0 4px 6px rgba(0,0,0,0.3); transition: 0.1s; display: none;}
        .action-btn:active { transform: scale(0.98); }
        
        .btn-row { display: flex; gap: 10px; width: 100%; }
        .secondary-btn { flex: 1; padding: 10px; font-size: 14px; font-weight: bold; border-radius: 8px; border: 1px solid #777; background: #333; color: white; cursor: pointer; }

        /* Pannello Setup Iniziale */
        #setup-screen { position: absolute; top:0; left:0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; text-align: center;}
        #setup-screen h2 { color: #2ed573; }
        .setup-input { font-size: 24px; padding: 10px; width: 100px; text-align: center; border-radius: 8px; border: 2px solid #2ed573; background: #222; color: white; margin: 20px 0;}
        #btnStart { background: #2ed573; color: black; font-size: 18px; padding: 15px 40px; border-radius: 30px; border: none; font-weight: bold; margin-top: 20px;}
        
        #sensor-error { color: #ff4757; margin-top: 20px; font-size: 14px; display: none;}
    </style>
</head>
<body>

    <!-- Fotocamera -->
    <video id="camera-bg" autoplay playsinline></video>
    
    <!-- Mirino -->
    <div id="crosshair"></div>
    <div id="angle-display">0.0¬∞</div>

    <!-- UI -->
    <div id="ui-container">
        <div id="top-bar">
            <!-- Dati Rilevati -->
            <div id="dataPanel" class="panel">
                <div class="data-row">Alt. Alb. A: <span id="hA" class="data-value">--</span> m</div>
                <div class="data-row">Alt. Alb. B: <span id="hB" class="data-value">--</span> m</div>
                <hr style="border-color:#555; margin: 8px 0;">
                <div class="data-row">Dist. A-B (3D):<br><span id="distAB" class="data-value" style="font-size: 18px;">--</span> m</div>
            </div>

            <!-- Calcolatore Antenna -->
            <div id="antennaPanel" class="panel">
                <strong>Configura Antenna</strong>
                <select id="antType">
                    <option value="none">Solo Distanza</option>
                    <option value="dipole">Dipolo (Centro)</option>
                    <option value="endfed">End Fed / Longwire</option>
                </select>

                <div id="setDipole" class="ant-settings">
                    Banda Ham:<br>
                    <select id="dipoleBand">
                        <option value="40">40m (~20m filo)</option>
                        <option value="20">20m (~10m filo)</option>
                        <option value="15">15m (~7m filo)</option>
                        <option value="10">10m (~5m filo)</option>
                    </select>
                </div>

                <div id="setEndFed" class="ant-settings">
                    Partenza da:<br>
                    <select id="efStart"><option value="A">Albero A</option><option value="B">Albero B</option></select>
                    Lung. Filo (m): <input type="number" id="efL1" value="20" step="1">
                    Corda Tirante (m): <input type="number" id="efDist" value="2" step="0.5">
                </div>
                
                <div id="warning">‚ö†Ô∏è Lo spazio tra gli alberi √® troppo piccolo per questa antenna!</div>
            </div>
        </div>

        <div class="bottom-controls">
            <div id="instruction">Inizializzazione fotocamera...</div>
            
            <button id="btnAction" class="action-btn">CATTURA BASE A</button>
            
            <div class="btn-row" style="margin-top: 10px;">
                <button id="btnReset" class="secondary-btn">üîÑ Reset Dati</button>
            </div>
        </div>
    </div>

    <!-- Schermata Setup (Altezza Occhi) -->
    <div id="setup-screen">
        <h2>Optical AR Planner</h2>
        <p>Tieni il telefono verticalmente all'altezza dei tuoi occhi.</p>
        <p>Inserisci a che altezza da terra si trova il telefono:</p>
        <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
            <input type="number" id="eyeHeight" class="setup-input" value="1.50" step="0.05"> <span style="font-size: 20px; font-weight: bold;">metri</span>
        </div>
        <button id="btnStart">AVVIA FOTOCAMERA</button>
        <div id="sensor-error">In attesa dei sensori... (Muovi il telefono)</div>
    </div>

    <script>
        // Variabili di sistema
        let eyeHeight = 1.50;
        let pitch = 0;   // Inclinazione su/gi√π in radianti
        let azimuth = 0; // Bussola in radianti
        let hasSensors = false;

        // Macchina a stati
        const STATES = {
            SETUP: 0,
            AIM_BASE_A: 1,
            AIM_BRANCH_A: 2,
            AIM_BASE_B: 3,
            AIM_BRANCH_B: 4,
            DONE: 5
        };
        let currentState = STATES.SETUP;

        // Dati misurati
        let treeA = { distBase: 0, height: 0, x: 0, z: 0 };
        let treeB = { distBase: 0, height: 0, x: 0, z: 0 };
        let distanceAB = 0;

        // Elementi DOM
        const video = document.getElementById('camera-bg');
        const angleDisplay = document.getElementById('angle-display');
        const instruction = document.getElementById('instruction');
        const btnAction = document.getElementById('btnAction');
        const btnStart = document.getElementById('btnStart');
        const setupScreen = document.getElementById('setup-screen');
        const crosshair = document.getElementById('crosshair');

        // Avvio Fotocamera
        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } 
                });
                video.srcObject = stream;
            } catch (err) {
                alert("Errore fotocamera. Assicurati di aver dato i permessi e di usare HTTPS.");
            }
        }

        // Lettura Sensori (Giroscopio/Bussola)
        function handleOrientation(event) {
            if (!event.beta || event.beta === null) return;
            hasSensors = true;
            document.getElementById('sensor-error').style.display = 'none';

            // Beta: -180 a 180. Telefono verticale = 90.
            // Calcoliamo l'angolo di inclinazione (Pitch). 
            // Positivo = Guardo in GI√ô. Negativo = Guardo in SU.
            let degrees = event.beta - 90; 
            pitch = degrees * (Math.PI / 180);

            // Alpha: Bussola (Azimuth)
            let compass = event.alpha || 0;
            azimuth = compass * (Math.PI / 180);

            // Aggiorna UI mirino
            angleDisplay.innerText = degrees.toFixed(1) + "¬∞";
            if(degrees > 0) {
                angleDisplay.style.color = "#ffdd59"; // Giallo (Gi√π)
                crosshair.style.setProperty('--c', '#ffdd59');
            } else {
                angleDisplay.style.color = "#2ed573"; // Verde (Su)
            }
        }

        // Calcoli Trigonometrici
        function calculateDistance(pitchAngle) {
            // d = h / tan(angolo). Serve angolo positivo (guardare in gi√π)
            if (pitchAngle < 0.02) return -1; // Troppo orizzontale o guarda in su
            return eyeHeight / Math.tan(pitchAngle);
        }

        function calculateHeight(distBase, pitchAngle) {
            // H = h_occhi - (distanza * tan(angolo))
            // Se guardo in su, l'angolo √® negativo, quindi diventa una somma
            return eyeHeight - (distBase * Math.tan(pitchAngle));
        }

        function calculate3DCoordinates(distBase, azim) {
            // Coordinate X e Z sul piano orizzontale
            return {
                x: distBase * Math.sin(azim),
                z: distBase * Math.cos(azim)
            };
        }

        function calculateDistanceAB() {
            // Teorema di Pitagora in 3D
            const dx = treeB.x - treeA.x;
            const dz = treeB.z - treeA.z;
            const dy = treeB.height - treeA.height; // Differenza di quota tra i rami
            return Math.sqrt(dx*dx + dy*dy + dz*dz);
        }

        // Gestione Logica dei Passaggi
        function advanceState() {
            switch(currentState) {
                case STATES.AIM_BASE_A:
                    let d1 = calculateDistance(pitch);
                    if (d1 < 0) { alert("Devi mirare in BASSO verso la radice dell'albero!"); return; }
                    treeA.distBase = d1;
                    
                    let coordsA = calculate3DCoordinates(d1, azimuth);
                    treeA.x = coordsA.x; treeA.z = coordsA.z;

                    currentState = STATES.AIM_BRANCH_A;
                    instruction.innerText = "2. Ora mira in ALTO al ramo dell'Albero A e premi.";
                    instruction.style.background = "#ff4757";
                    btnAction.innerText = "CATTURA RAMO A";
                    btnAction.style.background = "#ff4757";
                    break;

                case STATES.AIM_BRANCH_A:
                    treeA.height = calculateHeight(treeA.distBase, pitch);
                    document.getElementById('hA').innerText = treeA.height.toFixed(1);
                    
                    currentState = STATES.AIM_BASE_B;
                    instruction.innerText = "3. Spostati verso l'Albero B. Mira in BASSO alla sua radice e premi.";
                    instruction.style.background = "#1e90ff";
                    btnAction.innerText = "CATTURA BASE B";
                    btnAction.style.background = "#1e90ff";
                    break;

                case STATES.AIM_BASE_B:
                    let d2 = calculateDistance(pitch);
                    if (d2 < 0) { alert("Devi mirare in BASSO verso la radice!"); return; }
                    treeB.distBase = d2;
                    
                    let coordsB = calculate3DCoordinates(d2, azimuth);
                    treeB.x = coordsB.x; treeB.z = coordsB.z;

                    currentState = STATES.AIM_BRANCH_B;
                    instruction.innerText = "4. Mira in ALTO al ramo dell'Albero B e premi.";
                    btnAction.innerText = "CATTURA RAMO B";
                    break;

                case STATES.AIM_BRANCH_B:
                    treeB.height = calculateHeight(treeB.distBase, pitch);
                    document.getElementById('hB').innerText = treeB.height.toFixed(1);
                    
                    distanceAB = calculateDistanceAB();
                    document.getElementById('distAB').innerText = distanceAB.toFixed(1);

                    currentState = STATES.DONE;
                    instruction.innerText = "Misurazione completata. Configura l'antenna.";
                    instruction.style.background = "#2ed573";
                    btnAction.style.display = "none";
                    document.getElementById('antennaPanel').style.display = "block";
                    updateAntenna();
                    break;
            }
        }

        // Logica Antenna
        function updateAntenna() {
            if (currentState !== STATES.DONE) return;
            
            const type = document.getElementById('antType').value;
            document.querySelectorAll('.ant-settings').forEach(el => el.style.display = 'none');
            document.getElementById('warning').style.display = 'none';

            let requiredDist = 0;

            if (type === 'dipole') {
                document.getElementById('setDipole').style.display = 'block';
                const band = parseFloat(document.getElementById('dipoleBand').value);
                requiredDist = band / 2; // Lunghezza totale dipolo
            } else if (type === 'endfed') {
                document.getElementById('setEndFed').style.display = 'block';
                const l1 = parseFloat(document.getElementById('efL1').value);
                const tirante = parseFloat(document.getElementById('efDist').value);
                requiredDist = l1 + tirante;
            }

            if (requiredDist > distanceAB && type !== 'none') {
                document.getElementById('warning').style.display = 'block';
                document.getElementById('warning').innerText = `‚ö†Ô∏è L'antenna necessita di ${requiredDist}m, ma hai solo ${distanceAB.toFixed(1)}m.`;
            }
        }

        // Event Listeners
        window.addEventListener('deviceorientationabsolute', handleOrientation);
        // Fallback per dispositivi che non supportano 'absolute'
        window.addEventListener('deviceorientation', (e) => { if(!hasSensors) handleOrientation(e); });

        btnStart.addEventListener('click', () => {
            eyeHeight = parseFloat(document.getElementById('eyeHeight').value);
            if (isNaN(eyeHeight) || eyeHeight < 0.5) { alert("Inserisci un'altezza valida."); return; }
            
            if (!hasSensors) {
                document.getElementById('sensor-error').style.display = 'block';
                return; // Impedisce l'avvio se i sensori sono disattivati
            }

            setupScreen.style.display = 'none';
            initCamera();
            
            currentState = STATES.AIM_BASE_A;
            instruction.innerText = "1. Mira in BASSO alla radice dell'Albero A e premi.";
            btnAction.style.display = "block";
        });

        btnAction.addEventListener('click', advanceState);
        
        document.getElementById('btnReset').addEventListener('click', () => {
            currentState = STATES.AIM_BASE_A;
            document.getElementById('hA').innerText = '--';
            document.getElementById('hB').innerText = '--';
            document.getElementById('distAB').innerText = '--';
            document.getElementById('antennaPanel').style.display = 'none';
            
            instruction.innerText = "1. Mira in BASSO alla radice dell'Albero A e premi.";
            instruction.style.background = "#ffdd59";
            btnAction.innerText = "CATTURA BASE A";
            btnAction.style.background = "#2ed573";
            btnAction.style.display = "block";
        });

        document.getElementById('antType').addEventListener('change', updateAntenna);
        document.querySelectorAll('#antennaPanel select, #antennaPanel input').forEach(el => el.addEventListener('input', updateAntenna));

    </script>
</body>
</html>


